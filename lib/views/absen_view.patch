File? _imageFile;
  final ImagePicker _picker = ImagePicker();

  Future<String?> _getIpAddress() async {
    try {
      final ip = await Ipify.ipv4();
      return ip;
    } catch (e) {
      print('Error getting IP address: $e');
      return null;
    }
  }

=======
class _AbsenViewState extends State<AbsenView> {
  File? _imageFile;
  final ImagePicker _picker = ImagePicker();

  String _nip = 'N/A';

  @override
  void initState() {
    super.initState();
    _initializeData();
  }

  Future<void> _initializeData() async {
    final homeViewModel = Provider.of<HomeViewModel>(context, listen: false);
    await homeViewModel.fetchAndSaveCoordinates();

    final prefs = await SharedPreferences.getInstance();
    final userJsonString = prefs.getString('user');
    if (userJsonString != null) {
      try {
        final Map<String, dynamic> userMap = jsonDecode(userJsonString);
        if (userMap.containsKey('nip') && userMap['nip'].toString().trim().isNotEmpty) {
          _nip = userMap['nip'].toString().trim();
        }
      } catch (e) {
        print('Error decoding user JSON: \$e');
      }
    }
    if (_nip.isEmpty) {
      _nip = 'N/A';
    }
    setState(() {});
  }

  Future<String?> _getIpAddress() async {
    try {
      final ip = await Ipify.ipv4();
      return ip;
    } catch (e) {
      print('Error getting IP address: $e');
      return null;
    }
  }

>>>>>>> REPLACE
<<<<<<< SEARCH
  Future<void> _takePhoto() async {
    try {
      final XFile? pickedFile =
          await _picker.pickImage(source: ImageSource.camera);
      if (pickedFile != null) {
        // Prepare watermark text
        final homeViewModel = Provider.of<HomeViewModel>(context, listen: false);
        final UserModel? user = homeViewModel.user;

        String nip = (user?.nip ?? '').trim();
        print('Debug: user.nip = $nip');
        if (nip.isEmpty) {
          nip = 'N/A';
        }

        String currentYear = DateFormat('yyyy').format(DateTime.now());

        Map<String, dynamic>? coordinateData = await _getCoordinateData();
        print('Debug: coordinateData = $coordinateData');

        String latLong = '';
        if (coordinateData != null &&
            coordinateData['lat'] != null &&
            coordinateData['long'] != null) {
          final lat = coordinateData['lat'].toString().trim();
          final long = coordinateData['long'].toString().trim();
          latLong = '$lat, $long';
        } else if (user != null &&
            user.lat.isNotEmpty &&
            user.long.isNotEmpty) {
          latLong = '${user.lat.trim()}, ${user.long.trim()}';
        }
        latLong = latLong.trim();
        print('Debug: latLong = $latLong');
        if (latLong.isEmpty) {
          latLong = 'N/A';
        }

        String? ipAddress = await _getIpAddress();
        ipAddress ??= ''; // fallback empty string if null
        print('Debug: ipAddress = $ipAddress');

        String watermarkText = '''
Status: absen masuk
IMEI HP: null
APIP: $ipAddress
LAT-LONG: $latLong
TGL-JAM: ${DateFormat('dd/MM/yyyy HH:mm:ss').format(DateTime.now())}
NIP: $nip
dhe bdg kab $currentYear
''';

        File watermarkedFile =
            await _addWatermark(File(pickedFile.path), watermarkText);

        setState(() {
          _imageFile = watermarkedFile;
        });
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Gagal mengambil photo: $e')));
    }
  }
=======
  Future<void> _takePhoto() async {
    try {
      final XFile? pickedFile =
          await _picker.pickImage(source: ImageSource.camera);
      if (pickedFile != null) {
        Map<String, dynamic>? coordinateData = await _getCoordinateData();
        print('Debug: coordinateData = $coordinateData');

        String latLong = '';
        if (coordinateData != null &&
            coordinateData['lat'] != null &&
            coordinateData['long'] != null) {
          final lat = coordinateData['lat'].toString().trim();
          final long = coordinateData['long'].toString().trim();
          latLong = '$lat, $long';
        }
        latLong = latLong.trim();
        print('Debug: latLong = $latLong');
        if (latLong.isEmpty) {
          latLong = 'N/A';
        }

        String? ipAddress = await _getIpAddress();
        ipAddress ??= '';
        print('Debug: ipAddress = $ipAddress');

        String watermarkText = '''
Status: absen masuk
IMEI HP: null
APIP: $ipAddress
LAT-LONG: $latLong
TGL-JAM: ${DateFormat('dd/MM/yyyy HH:mm:ss').format(DateTime.now())}
NIP: $_nip
dhe bdg kab ${DateFormat('yyyy').format(DateTime.now())}
''';

        File watermarkedFile =
            await _addWatermark(File(pickedFile.path), watermarkText);

        setState(() {
          _imageFile = watermarkedFile;
        });
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Gagal mengambil photo: $e')));
    }
  }
